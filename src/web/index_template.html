<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Odin + Raylib on the web</title>
    <meta name="viewport" content="width=device-width">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }

        canvas.game_canvas {
            background: black;
            display: block;
            margin: 0 auto;
            border: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <canvas class="game_canvas" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"
        onmousedown="event.target.focus()" onkeydown="event.preventDefault()"></canvas>

    <script src="odin.js"></script>
    <script>
        // Keep a reference to WASM exports once instantiated
        let odinWasmExports = null;

        const odinMemoryInterface = new odin.WasmMemoryInterface();
        odinMemoryInterface.setIntSize(4);
        const odinImports = odin.setupDefaultImports(odinMemoryInterface);

        // Emscripten config object
        var Module = {
            instantiateWasm: (imports, success) => {
                const merged = { ...odinImports, ...imports };
                return WebAssembly.instantiateStreaming(fetch("game.wasm"), merged).then((res) => {
                    const e = res.instance.exports;
                    odinWasmExports = e;                         // <- keep it
                    odinMemoryInterface.setExports(e);
                    odinMemoryInterface.setMemory(e.memory);
                    return success(res.instance);
                });
            },

            onMemoryGrowth() {
                // Rebind Odinâ€™s views to the new buffer after growth
                odinMemoryInterface.setMemory(odinWasmExports.memory);
            },

            onRuntimeInitialized: () => {
                const e = odinWasmExports || odinMemoryInterface.getExports();
                // Calls any procedure marked with @init
                e._start();

                // See source/main_web/main_web.odin for these procs
                e.main_start();

                function send_resize() {
                    const canvas = document.getElementById('canvas');
                    e.web_window_size_changed(canvas.width, canvas.height);
                }

                window.addEventListener('resize', send_resize, true);
                send_resize();

                function tick() {
                    if (!e.main_update()) {
                        e.main_end();
                        e._end(); // calls @fini
                        return;
                    }
                    requestAnimationFrame(tick);
                }
                requestAnimationFrame(tick);
            },

            print: (() => {
                const el = document.getElementById("output");
                if (el) el.value = '';
                return (text) => {
                    if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                    console.log(text);
                    if (el) { el.value += text + "\n"; el.scrollTop = el.scrollHeight; }
                };
            })(),

            canvas: (() => document.getElementById("canvas"))()
        };
    </script>

    <!-- Emscripten injects its JS glue here -->
  <script src="game.js"></script>
</body>

</html>
